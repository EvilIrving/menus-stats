# Issue 001: SMC 温度/风扇在打包后 App 不显示

## Summary

打包后的 menu-stats.app 运行时，温度和风扇转速显示为 N/A，无法读取 SMC 数据。

## Environment

- **设备**: MacBook M2 Pro / Mac Mini M4 (Apple Silicon)
- **macOS**: 14.x+
- **Xcode**: 17.x
- **Sandbox**: 已禁用 (`com.apple.security.app-sandbox = false`)

## Reproduction Steps

1. 使用 Xcode 构建 Release 版本
2. 运行打包后的 menu-stats.app
3. 查看状态栏和概览 Tab

## Expected vs Actual

- **期望**: 显示 CPU 温度（如 45℃）和风扇转速（如 1200 RPM）
- **实际**: 温度和风扇均显示 N/A

## Investigation

### 2024-12-25 调查记录

#### 1. 原始实现问题

原始 SMCInfo 实现存在以下问题：

1. **SMCParamStruct 结构体布局不正确**
   - 错误地使用元组表示嵌套结构体
   - 添加了不应存在的 `padding: UInt16` 字段
   - 使用 UInt8 而非 CChar

2. **缺少 GetKeyInfo 步骤**
   - 直接尝试读取数据，未先获取 key 信息
   - 正确流程: kSMCGetKeyInfo → kSMCReadKey

3. **Apple Silicon 温度键不全**
   - 仅包含少量键，缺少 M2/M4 专用键

#### 2. 参考资料

- [smctemp](https://github.com/narugit/smctemp) - Apple Silicon 兼容的 SMC 温度工具
- [SMCKit](https://github.com/beltex/SMCKit) - Intel Mac SMC 库

#### 3. Apple Silicon 温度键

从 smctemp 获取的 Apple Silicon 温度键列表：
- CPU cluster: `Tc0a`, `Tc0b`, `Tc0x`, `Tc0z`
- P-cores: `Tp01`, `Tp05`, `Tp09`, `Tp0D`, `Tp0H`, `Tp0L`, `Tp0P`, `Tp0T`, `Tp0X`, `Tp0b`, `Tp0f`, `Tp0j`, `Tp0n`, `Tp0r`
- Pro/Max: `Tp1h`, `Tp1t`, `Tp1p`, `Tp1l`
- GPU: `Tg05`, `Tg0D`, `Tg0L`, `Tg0P`, `Tg0T`, `Tg0X`, `Tg0b`, `Tg0f`, `Tg0j`, `Tg0v`, `Tg1b`, `Tg4b`

## Fix

### task017: 修复 SMC 结构体和读取流程

**修改文件**: `SystemMonitor.swift` - SMCInfo 模块

1. **修正 SMCParamStruct 结构体** (匹配 smctemp.h)
   ```swift
   private struct SMCVersion {
       var major: CChar = 0
       var minor: CChar = 0
       var build: CChar = 0
       var reserved: CChar = 0
       var release: UInt16 = 0
   }
   
   private struct SMCPLimitData {
       var version: UInt16 = 0
       var length: UInt16 = 0
       var cpuPLimit: UInt32 = 0
       var gpuPLimit: UInt32 = 0
       var memPLimit: UInt32 = 0
   }
   
   private struct SMCKeyInfoData {
       var dataSize: UInt32 = 0
       var dataType: UInt32 = 0
       var dataAttributes: CChar = 0
   }
   
   private struct SMCParamStruct {
       var key: UInt32 = 0
       var vers = SMCVersion()
       var pLimitData = SMCPLimitData()
       var keyInfo = SMCKeyInfoData()
       var result: CChar = 0  // 注意: 无 padding
       var status: CChar = 0
       var data8: CChar = 0
       var data32: UInt32 = 0
       var bytes: (UInt8 x 32) = ...
   }
   ```

2. **实现两步读取流程**
   ```swift
   private static func readKey(_ key: String) -> [UInt8]? {
       // Step 1: kSMCGetKeyInfo (selector 9)
       // Step 2: kSMCReadKey (selector 5)
   }
   ```

3. **扩展 Apple Silicon 温度键列表**
   - 添加 Tc0a/Tc0b/Tc0x/Tc0z 等 cluster 温度键
   - 添加完整的 P-core 温度键

4. **添加调试函数**
   - `debugSMC()` 输出结构体大小和测试键读取结果到 `/tmp/menu-stats-smc-debug.log`

## Verification

- [ ] 在 M2 Pro 上运行，检查温度是否显示
- [ ] 在 M4 上运行，检查温度是否显示
- [ ] 检查风扇转速（MacBook Air 无风扇设计预期返回 nil）

## Related

- **Task**: task017
- **Files**: `SystemMonitor.swift`
- **Commit**: (待提交)

## Resolved At/By

- **Status**: 调查中
- **Resolved At**: -
- **Resolved By**: -
