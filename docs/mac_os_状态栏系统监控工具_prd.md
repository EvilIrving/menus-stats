# macOS 状态栏系统监控工具 PRD

## 一、背景与目标

### 1. 背景

macOS 自带的「活动监视器」功能强大，但存在以下问题：

- 必须打开独立窗口，无法常驻可见
- 信息密度高但获取路径长，不适合频繁查看
- 普通用户很少真正理解 CPU / 内存 / GPU 的实时状态

大量第三方用户真实需求集中在：

- **随时知道系统是否“忙”**
- **快速定位内存被谁占用**
- **在必要时快速释放资源**

### 2. 产品目标

打造一个：

- 常驻 macOS 状态栏
- 信息准确、展示克制
- 不替代活动监视器，但覆盖 80% 高频需求

关键词：**快速感知 · 只读为主 · 克制操作**。

---

## 二、整体产品结构

### 1. 核心形态

- 类型：macOS 状态栏 App
- 常驻状态栏，一个图标 + 若干状态文本
- 点击状态栏，弹出 Popover

### 2. 核心页面

```
状态栏
  ↓ 点击
Popover
 ├── 概览 Tab
 └── 清理释放 Tab
```

---

## 三、状态栏设计

### 1. 状态栏内容

- 仅一个 `NSStatusItem`
- 顺序固定，不允许用户调整

固定顺序如下：

```
Logo / CPU / GPU / MEM / DISK / NET / FAN
```

### 2. 双行显示布局

每个监控项采用上下双行结构：

- **上方**：显示数值（如 `62%`、`99 GB`），使用较小字号（9pt 等宽数字字体）
- **下方**：显示文字标签（如 `CPU`、`DISK`），字号更小（7pt），颜色为次要色

**网络项特殊处理**：

- 上方显示上传速度（如 `↑7.5 KB/s`）
- 下方显示下载速度（如 `↓7.5 KB/s`）
- 上下两行使用相同字号（9pt 等宽数字字体），间距更紧凑

**风扇转速**:

状态栏不显示具体的转速，设计一个模拟风扇旋转的效果。转速越高，风扇转速越快。为了降低风扇太快，需限制模拟风扇的最大转速。

### 3. 固定宽度格子

为避免数值变化导致界面抖动，每种监控项使用固定宽度：

| 项目 | 宽度 | 示例内容 |
|------|------|----------|
| Logo | 18pt | ◉ |
| CPU | 32pt | 99% |
| GPU | 32pt | 41% |
| MEM | 32pt | 59% |
| DISK | 48pt | 999 GB（向上取整） |
| NET | 70pt | ↑99.9 MB/s / ↓99.9 MB/s |
| FAN | 58pt | 9999 RPM |
| 分隔间距 | 8pt | - |

技术要点：

- 使用 `monospacedDigitSystemFont` 确保数字等宽
- 每个格子内文字居中对齐
- 总宽度根据启用项目动态计算

### 4. 显示规则

- 每一项支持「是否显示」开关
- **至少需要选中 1 项**
- 当用户尝试全部关闭时：
  - 自动保留 CPU 项
  - 提示：
    > “状态栏至少需要显示一个系统状态”

---

## 四、Popover 设计

Popover 仅包含两个 Tab，避免复杂导航。

```
┌──────── Popover ────────┐
│  概览 | 清理释放        │
├────────────────────────┤
│  内容区                │
└────────────────────────┘
```

---

## 五、概览 Tab（统计数据）

概览 Tab 分为三个区域：主信息区、系统状态区、核心使用率区。

### 1. 主信息区（圆环饼图）

展示三个圆环饼图，水平排列：

```
    ╭───╮          ╭───╮          ╭───╮
   ╱     ╲        ╱     ╲        ╱     ╲
  │  62%  │      │  41%  │      │  59%  │
   ╲     ╱        ╲     ╱        ╲     ╱
    ╰───╯          ╰───╯          ╰───╯
     CPU            GPU            MEM
```

| 指标 | 显示形式 | 交互 |
|------|---------|------|
| CPU 总使用率 | 圆环饼图 + 中心百分比 + 下方 label | 鼠标悬浮显示 System / User 占比 |
| GPU 利用率 | 圆环饼图 + 中心百分比 + 下方 label | 无悬浮 |
| 内存使用率 | 圆环饼图 + 中心百分比 + 下方 label | 无悬浮 |

CPU 悬浮提示示例：

```
┌─────────────────┐
│  System   48%   │
│  User     14%   │
└─────────────────┘
```

---

### 2. 系统状态区（文字显示）

以文字形式展示以下信息：

```
🌡️ 温度    43℃
🌀 风扇    1001 RPM
💾 磁盘    可用 164 GB / 共 245 GB
🌐 网络    ⬆ 18.0 KB/s   ⬇ 9.0 KB/s
```

| 指标 | 显示内容 | 说明 |
|------|---------|------|
| 温度 | CPU 温度（可用则显示） | 单位支持 ℃ / ℉ 切换 |
| 风扇 | 当前转速 RPM | 多风扇时显示最大值 |
| 磁盘 | 可用空间 / 总空间 | - |
| 网络 | 实时上传 / 下载速度 | 单位支持 KB/s / MB/s 切换 |

---

### 3. 核心使用率区（可滚动列表）

放置于概览 Tab 最下方，用户可下拉滚动查看。

展示形式：

- 每个核心一行，横向进度条
- 左侧显示核心编号，右侧显示百分比
- 百分比数字颜色随负载渐变（绿→黄→红）

```
核心使用率                               ▼ 下拉查看
─────────────────────────────────────────────────────
Core 0   ■■■■■■■■■■■■■■■■■■■■■■■■□□□□□□       82%
Core 1   ■■■■■■■■■■■■■■■■■■■■□□□□□□□□□□       65%
Core 2   ■■■■■■■■■■■■■■■■■■■■■■■■■■■□□□       91%
Core 3   ■■■■■■■□□□□□□□□□□□□□□□□□□□□□□□       23%
...                                      (可滚动)
```

配色规则：

| 负载范围 | 颜色 |
|---------|------|
| 0-50% | 🟢 绿色（正常） |
| 51-80% | 🟡 黄色（注意） |
| 81-100% | 🔴 红色（繁忙） |

说明：

- 当前 Mac 设备逻辑核心数范围 8-24 核
- 核心列表固定高度，超出可滚动查看
- 单核负载为非首要关注信息，故放置于最下方

---

## 六、清理释放 Tab（内存占用管理）

### 1. 设计目标

> 快速回答一个问题：**是哪个 App 占了最多内存，我能不能关掉它？**

### 2. 核心规则（强约束）

- **仅显示用户 App**
  - 包含 Dock 应用（`activationPolicy == .regular`）
  - 包含状态栏应用（`activationPolicy == .accessory`），如 Clash Verge、Bartender 等
- 不显示任何系统 App / 后台服务（`activationPolicy == .prohibited`）
- 排序方式固定：**按内存占用从大到小**
- 不支持搜索、不支持排序切换

---

### 3. 进程合并规则

现代 macOS 应用（如 Electron 应用、使用 WebKit 的应用）会创建多个子进程，需要合并显示。

#### 合并策略

- **按进程树合并**：使用 `ppid` 找到父进程，将子进程内存累加到顶层用户进程
- **WebKit 进程特殊处理**：`com.apple.WebKit.*` 进程通过名称前缀匹配归属父应用
- **孤儿进程**：父进程已退出（ppid=1）的进程作为独立应用处理

#### 显示格式

| 场景 | 显示格式 | 示例 |
|------|---------|------|
| 单进程 | `App名称` | `Finder    320 MB` |
| 多进程 | `App名称 (N)` | `Clash Verge (4)    856 MB` |

#### 数据规则

- **图标**：使用主进程图标
- **名称**：使用主进程名称
- **内存**：所有子进程内存累加
- **排序**：按合并后总内存排序

---

### 4. 顶部摘要区

列表顶部展示内存使用概览：

```
┌────────────────────────────────────────────────┐
│  💾 内存使用中  14.2 GB / 16 GB  (89%)         │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━░░░░       │
│  🚀 运行中 App: 12 个                          │
└────────────────────────────────────────────────┘
```

| 项目 | 说明 |
|------|------|
| 内存占用量 | 已用 / 总量 + 百分比 |
| 进度条 | 可视化占用比例，颜色随内存压力变化（绿→黄→红） |
| App 计数 | 当前列表中运行的用户 App 数量 |

---

### 5. 列表结构

每一行包含：

- App 图标
- App 名称
- 内存占用（GB / MB）
- 操作按钮：`关闭`（悬浮时显示）

---

### 6. 列表行交互（右推滑出式）

#### 默认状态

```
[Chrome 图标]  Chrome                              4.76 GB
[Xcode 图标]   Xcode                               2.45 GB
[WeChat 图标]  WeChat                              1.77 GB
```

#### 悬浮到行时

鼠标悬浮到某一行，整行内容微微左移，右侧滑出关闭按钮：

```
[Chrome 图标]  Chrome                    4.76 GB    [✕]
                                                    ↑ 滑出
```

#### 悬浮到关闭按钮时

鼠标悬浮到 `[✕]` 按钮上，显示 Tooltip 提示：

```
[Chrome 图标]  Chrome                    4.76 GB    [✕]
                                                     ↓
                                         ┌─────────────────────────────┐
                                         │ 关闭应用前请确认已保存数据   │
                                         └─────────────────────────────┘
```

#### 交互时序

| 步骤 | 鼠标位置 | 界面状态 |
|------|---------|----------|
| 1 | 行外 | 显示内存占用，无按钮 |
| 2 | 进入行内（非按钮区域） | 按钮 `[✕]` 滑出，无 Tooltip |
| 3 | 悬浮到 `[✕]` 按钮上 | 显示 Tooltip 提示文案 |
| 4 | 鼠标移开行 | 按钮收起，恢复默认状态 |

#### Tooltip 样式

- 使用系统原生 Tooltip（SwiftUI `.help()` 修饰符）
- 延迟约 0.5s 后显示，避免快速划过时闪烁
- 文案：`"关闭应用前请确认已保存数据"`

---

### 7. 关闭 App 行为规范

#### 默认行为（单进程）

- 调用：`terminate()`

#### 默认行为（多进程）

1. 先 `terminate()` 主进程（通常会自动关闭子进程）
2. 等待短暂时间后，检查子进程是否仍存活
3. 如有存活子进程，逐个 `terminate()`

#### 失败时

- 弹窗二次确认：
  > “应用未响应，是否强制关闭？可能导致未保存的数据丢失。”

#### 强制关闭

- 对主进程及所有子进程调用 `forceTerminate()`

#### 禁止行为

- 不允许关闭系统 App
- 不允许关闭无 UI 的后台进程

---

## 七、设置页面

### 1. 状态栏显示设置

Checkbox 列表：

- Logo
- CPU
- GPU
- MEM
- Disk
- Net
- Fan

规则：

- 至少一个必须勾选
- 全部取消时自动恢复 CPU

---

### 2. 其他设置

- 刷新频率：低 / 中 / 高
- 温度单位：℃ / ℉
- 网速单位：KB/s / MB/s

---

## 八、技术选型

### 1. 技术栈

- 语言：Swift
- UI：SwiftUI + AppKit（NSStatusItem）
- 最低系统版本：macOS 14 (Sonoma)
  - 支持最近 3 个主要版本（macOS 14/15/26）可覆盖约 90% 的活跃用户
- 系统接口：
  - Mach API
  - IOKit
  - NSRunningApplication

---

## 九、核心算法说明（伪代码）

### 1. CPU 使用率（Mach）

```pseudo
prev = read_cpu_ticks()
sleep(1s)
now = read_cpu_ticks()
delta = now - prev
cpu_usage = (user + system) / total
```

---

### 2. 单核 CPU

```pseudo
cores = host_processor_info()
for core in cores:
  usage = (user + system) / total
```

---

### 3. GPU 利用率（IOKit）

```pseudo
service = find IOAccelerator
stats = service["PerformanceStatistics"]
util = stats["Device Utilization %"]
```

---

### 4. 内存统计

```pseudo
vm = host_vm_info()
used = active + wired + compressed
percent = used / total
```

---

### 5. App 内存占用

```pseudo
for app in runningApplications:
  task = task_for_pid(app.pid)
  mem = task.resident_size
```

---

## 十、用户友好提示（UX 文案）

### 1. 关闭 App 按钮悬浮提示
>
> “关闭应用前请确认已保存数据，强制关闭可能导致数据丢失。”

### 2. 全部取消状态栏显示
>
> “状态栏至少需要显示一个系统状态。”

### 3. GPU / 温度不可用
>
> “当前设备暂不支持该项数据获取。”

---

## 十一、非目标（明确不做）

- 不提供自动清理
- 不修改系统参数
- 不常驻后台扫描高频数据
- 不替代活动监视器

---

## 十二、总结

本产品是一个：

- **状态栏优先**
- **统计只读为主**
- **操作极度克制**

的 macOS 系统监控工具。

目标不是“什么都管”，而是**让用户在 3 秒内知道：系统现在正不正常**。

---

## 十三、开发验证

- 无须自动化验证构建和运行
- 用户自行在 Xcode 中构建并测试
