# 内存占用（清理释放）Tab

---

## 1. 设计目标

> 快速回答一个问题：**是哪个 App 占了最多内存，我能不能关掉它？**

---

## 2. 核心规则

### 2.1 App 显示规则

取决于应不应该显示，显示了是否合理，而非固定逻辑，参考：

- **用户安装的 App**：如 WeChat、Chrome
- **部分系统 App**：如终端、备忘录、日历
- **状态栏/后台应用**：如输入法（搜狗输入法等可能占用大量内存）

### 2.2 排序规则

按**内存占用大小**降序排列

### 2.3 显示格式

| 场景 | 显示格式 | 示例 |
|------|---------|------|
| 单进程 | `App名称` | `Finder    320 MB` |
| 多进程 | `App名称 (N)` | `Clash Verge (4)    856 MB` |

---

## 3. 界面布局

### 3.1 顶部摘要区

| 项目 | 说明 |
|------|------|
| 内存占用 | 已用 / 总量 + 百分比 |
| 进度条 | 可视化占用比例，颜色随内存压力变化（绿→黄→红） |

### 3.2 可清理内存区

横向并排布局：

| 组件 | 说明 |
|------|------|
| 可清理环形图 | 显示可清理内存占比（仅 Purgeable） |
| 说明文字 | "可清理内存" + "系统可释放的缓存数据" |
| 清理按钮 | 触发系统内存清理（注：由系统自动管理，效果有限） |

> 注：External（文件缓存）由系统自动管理，不属于可清理范围，已移至指标区展示

### 3.3 内存指标区

显示关键内存指标，**按占用大小降序排列**，鼠标悬浮显示概念说明：

| 指标 | 说明 | 悬浮提示 |
|------|------|----------|
| 活跃 | Active | 正在被应用程序使用的内存，最近被访问过 |
| 非活跃 | Inactive | 最近未被访问的内存，可能被重新分配 |
| 联动 | Wired | 系统核心使用的内存，不可被换出或释放 |
| 压缩 | Compressed | 被压缩以节省空间的内存数据 |
| 推测 | Speculative | 系统预读的数据，可被快速释放 |
| 文件缓存 | External | 文件系统缓存，由系统自动管理 |
| 交换区 | Swap Used | 已使用的磁盘交换空间，内存不足时启用 |
| 可清理 | Purgeable | 应用标记可丢弃的内存，系统可随时释放 |

### 3.4 App 占用列表

- 列表上方显示当前运行的用户 App 数量
- 每行包含：
  - App 图标
  - App 名称
  - 内存占用（GB / MB）
  - 操作按钮：`关闭`（悬浮时显示）

---

## 4. 交互规范

### 4.1 列表行交互（右推滑出式）

**默认状态：**

```
[Chrome 图标]  Chrome                              4.76 GB
[Xcode 图标]   Xcode                               2.45 GB
[WeChat 图标]  WeChat                              1.77 GB
```

**悬浮到行时：** 整行内容微微左移，右侧滑出关闭按钮

```
[Chrome 图标]  Chrome                    4.76 GB    [✕]
                                                    ↑ 滑出
```

**悬浮到关闭按钮时：** 显示 Tooltip 提示

```
[Chrome 图标]  Chrome                    4.76 GB    [✕]
                                                     ↓
                                         ┌─────────────────────────────┐
                                         │ 关闭应用前请确认已保存数据   │
                                         └─────────────────────────────┘
```

### 4.2 交互时序

| 步骤 | 鼠标位置 | 界面状态 |
|------|---------|----------|
| 1 | 行外 | 显示内存占用，无按钮 |
| 2 | 进入行内（非按钮区域） | 按钮 `[✕]` 滑出，无 Tooltip |
| 3 | 悬浮到 `[✕]` 按钮上 | 显示 Tooltip 提示文案 |
| 4 | 鼠标移开行 | 按钮收起，恢复默认状态 |

### 4.3 Tooltip 样式

- 使用系统原生 Tooltip（SwiftUI `.help()` 修饰符）
- 延迟约 0.5s 后显示，避免快速划过时闪烁
- 文案：`"关闭应用前请确认已保存数据"`

---

## 5. 关闭 App 行为规范

### 5.1 单进程关闭

- 调用 `terminate()` 方法

### 5.2 多进程关闭

1. 先 `terminate()` 主进程（通常会自动关闭子进程）
2. 等待短暂时间后，检查子进程是否仍存活
3. 如有存活子进程，逐个 `terminate()`

### 5.3 关闭失败处理

弹窗二次确认：
> "应用未响应，是否强制关闭？可能导致未保存的数据丢失。"

### 5.4 强制关闭

- 对主进程及所有子进程调用 `forceTerminate()`

### 5.5 禁止行为

- ❌ 不允许关闭系统 App
- ❌ 不允许关闭无 UI 的后台进程

---

## 6. 技术实现

### 6.1 进程获取与合并

使用 top 命令获取内存占用进程：

```bash
/usr/bin/top -l 1 -o mem -n N -stats pid,command,mem
```

- **数据处理**：解析输出，支持单位转换（KB、MB、GB）
- **进程合并**：按责任进程分组显示（使用 `responsibility_get_pid_responsible_for_pid`）

### 6.2 内存使用统计

通过 Mach 虚拟内存统计接口获取：

| 配置项 | 值 |
|-------|---|
| API | `host_statistics64()` + `HOST_VM_INFO64` |
| 数据结构 | `vm_statistics64_data_t` |

**关键指标：**

- Active（活跃内存）
- Inactive（非活跃内存）
- Wired（联动内存）
- Compressed（压缩内存）
- Speculative（推测内存）
- Purgeable（可清除内存，支持一键清除）

### 6.3 内存压力监控

通过 sysctl 获取内存压力等级：

```c
sysctlbyname("kern.memorystatus_vm_pressure_level")
```

| 压力等级 | 值 |
|---------|---|
| Normal（正常） | 其他值 |
| Warning（警告） | 2 |
| Critical（危急） | 4 |

### 6.4 交换区监控

获取虚拟内存交换使用情况：

```c
sysctlbyname("vm.swapusage")
```

| 配置项 | 值 |
|-------|---|
| 数据结构 | `xsw_usage` |
| 统计指标 | 总量、已用、可用交换空间 |

### 6.5 系统 API 汇总

| API 类别 | API 名称 | 访问权限 | 功能说明 |
|---------|---------|---------|----------|
| Mach Kernel | `host_info` | 公开 | 获取主机基本信息（总内存） |
| Mach Kernel | `host_statistics64` | 公开 | 获取虚拟内存统计 |
| System | `sysctlbyname` | 公开 | 获取内存压力和交换区信息 |
| System | `dlsym` | 公开 | 动态加载责任进程函数 |

---
